define(["jquery","eventDispatcher","breakpoints","viewport","ga4ProductGrid"],function(t,e,n,a,i){function o(){var t=r("filter");A.addClass(D),y().then(function(e){var n;s(e),p(t)?(n=l()+"?filter="+t,y(n).then(function(t){f(t),A.removeClass(D)})):A.removeClass(D)},function(){A.removeClass(D)})}function r(t){var e,n;return!window.location.search||window.location.search.indexOf(t)<0?null:(e=t.length+1+window.location.search.indexOf(t+"="),n=window.location.search.indexOf("&",e),n>e?window.location.search.substring(e,n):window.location.search.substring(e))}function l(){var t=0;return t=window.location.pathname.split("/ca/").length>2?window.location.pathname.replace("/ca/","").indexOf("/ca/")+4:window.location.pathname.indexOf("/ca/"),t>-1?window.location.pathname.substring(t):null}function c(){null===j?window.location.reload():window.location.href=window.location.origin+hybris.contextPath+j}function s(t){var e="",n=A.data("translation-all");t.forEach(function(t,a){e+='<li class="filter-tray-item'+(0===a?" "+T:"")+'">\n	<span class="facet-title">'+t.name+'</span>\n	<div class="facets-list-wrapper">\n		<ul class="facets-list" data-facet-code="'+t.code+'" data-facet-code-localized="'+t.name+'">\n			<li class="facet-item facet-item-all">\n				<button class="'+T+'" '+z+'="'+t.removeAllQuery.url+'" data-facet-value-uri-code="all" data-index="0" data-facet-value-localized="'+n+'">'+F+n+"</button>\n			</li>\n";var i=0;t.values.forEach(function(n){const a="colors"===t.code?n.name.split("|")[0]:n.name;"U"!==a&&"Undefined"!==a&&(i+=1,e+='			<li class="facet-item">\n				<button '+z+'="'+n.query.url+'" data-facet-value-uri-code="'+encodeURI(n.code)+'" data-index="'+i+'" data-facet-value-localized="'+encodeURI(a)+'">'+F+a+"</button>\n			</li>\n")}),e+="		</ul>\n	</div>\n</li>\n"}),I.empty().append(e),d(),v()}function u(t,e){for(var n=0;n<e.values.length;n++)if(t===e.values[n].code)return e.values[n];return null}function f(e){for(var n={},a=0;a<e.length;a++)n[e[a].code]=e[a];t(".filter-tray .facets-list").each(function(){var e=t(this).attr("data-facet-code");if(n[e]){var a=t(".facet-title",t(this).closest(".filter-tray-item")),i=t(".facet-item-all > button",this),o=t(".facet-item:not(.facet-item-all) > button",this),r=0;o.each(function(){var a=decodeURI(t(this).attr("data-facet-value-uri-code")),i=u(a,n[e]);null!==i?(t(this).removeClass(_).attr(z,i.query.url),i.selected?(t(this).addClass(T),r++):t(this).removeClass(T)):t(this).addClass(_).removeClass(T).removeAttr(z)}),t(".filter-total-count",a).remove(),r?(a.append('<span class="filter-total-count"> ('+r+")</span>"),i.removeClass(T).attr(z,n[e].removeAllQuery.url)):i.addClass(T).removeAttr(z)}})}function d(){if(n.is("standard")){var e=h(q);e.length&&t(".filter-tray .facets-list").each(function(n){t(this).removeClass("columns-"+t(this).attr("data-columns")).addClass("columns-"+e[n]).attr("data-columns",e[n])})}}function h(e){var n=t(".filter-tray > li"),i=Math.floor(R+(a.get().width-1024)/150),o=[],r=0;return n.length>i?(console.warn("too many facet columns to fit in one line"),[]):(n.each(function(){var n=t(".facet-item",this).length,a=Math.ceil(n/e);o.push(a),r+=a}),i>=r?o:h(e+1))}function v(){var t=P.hasClass(T);P.addClass(T),A.height()<I[0].scrollHeight+O.outerHeight()?O.addClass(E):O.removeClass(E),t||P.removeClass(T)}function m(t){for(var e=[],n=0;n<t.facets.length;n++)t.facets[n].visible&&"line"!==t.facets[n].code&&e.push(t.facets[n]);return e.sort(function(t,e){return t.code<e.code?-1:1})}function p(t){if(!t)return!1;for(var e=decodeURIComponent(t).split(":"),n=0;n<e.length;n+=2)if("line"!==e[n]&&""!==e[n])return!0;return!1}function w(t,e){for(var n=e.split(":"),a=[],i=0;i<n.length;i+=2)(n[i]===t||""===n[i])&&a.push(n[i]+":"+n[i+1]);return a.join(":")}function g(){var t=window.location.pathname.split("/");return isNaN(parseInt(t[t.length-1],10))?window.location.pathname:(t.pop(),t.join("/"))}function y(t){var e=window.location.origin;if(t)e+=hybris.contextPath+t.replace("?","/facets?");else{e+=g()+"/facets";var n=r("filter");if(null!==n){var a=w("line",decodeURIComponent(n));a&&(e+="?filter="+a.replace(/:/g,"%3A"))}}return C(e).then(function(t){return m(t)})}function C(e,n){var a=[1,3,5,10,30];return n=n||0,t.ajax({url:e}).then(function(t){return t},function(i){var o=t.Deferred(),r=a[n];return"undefined"==typeof r?o.reject(i):setTimeout(function(){C(e,n+1).then(function(t){o.resolve(t)},function(t){o.reject(t)})},1e3*r),o})}function b(e){t(e.target).hasClass("facet-title")&&(t(this).toggleClass(T).siblings().removeClass(T),clearTimeout(U),U=setTimeout(v,500))}function x(){A.on("click",".facet-item button",function(e){k(e);var n=t(this).attr(z);n&&(A.addClass(D),y(n).then(function(t){A.removeClass(D),j=n,f(t)}))}),t(".filter-tray-apply-button").on("click",function(){i.pushFilterByFilterProductGrid(),c()}),t(".filter-tray-cancel-button").on("click",function(t){P.click(),t.stopPropagation()}),t("body").on("click",".filter-tray-item",b),t(window).on("resize",function(){d(),v()})}function k(t){t&&t.preventDefault&&t.preventDefault()}var U,j=null,A=t(".filter-tray-wrapper"),I=t(".filter-tray"),O=t(".filter-tray-footer"),P=t(".filter-facets-expander"),R=6,q=5,z="data-facet-query-url",D="_loading",T="_active",_="_unavailable",E="filter-tray-footer-pseudo-sticky",F='<span class="checkbox-custom"><i class="ico-check"></i></span>';return{load:function(){function t(){}o(),x(),e.dispatchAndListen("filterTray",t)}}});