define(["jquery","eventDispatcher","breakpoints","os"],function(e,r,a,t){function i(){return e(".product-tiles-grid-item:visible",v).length+e(".product-tiles-grid-promo-component:visible",v).length}function o(){function r(){var r=e(".element_left").data("numberinpage"),a=e(".element_left").data("rows");r/=5;for(var t=r;a>t;t++)e(e("div.product-grid-row-background-wrapper.product-grid-row-background-wrapper--large > img")[t]).css("display","none")}e(".capsule-products-grid-tiles").length>1&&setTimeout(function(){r()},0);var a=e('[data-module="ajaxPagination"]');if(0===a.length)return null;var t=a.data("items-per-page"),i=a.data("total-items"),o=a.data("total-pages"),n=a.data("promos-positions"),l={small:[0],medium:[0],large:[0]};if(o>0){l.small.push(Math.ceil((t+2*n.length)/2)),l.medium.push(Math.ceil(t/3)),l.large.push(Math.ceil((t+2*n.length)/4));for(var d=2;o>d;d++)l.small.push(l.small[d-1]+Math.ceil(t/2)),l.medium.push(l.medium[d-1]+Math.ceil(t/3)),l.large.push(l.large[d-1]+Math.ceil(t/4))}return l.small.push(Math.ceil((i+2*n.length)/2)),l.medium.push(Math.ceil(i/3)),l.large.push(Math.ceil((i+2*n.length)/4)),l}function n(r,a){e.each(["small","medium","large"],function(t,i){var o=e(".product-grid-row-background-wrapper--"+i+":not(.product-grid-row-background-wrapper--"+i+"-hidden)"),n=e(".product-grid-row-background-wrapper--"+i+"-hidden");if(o.length){for(var d=o.data("background-list-size"),s=o.data("is-repeat"),u=[],c=w[i][a];c<w[i][a+1];c++){var p=c%d;if(!s&&c>=d)break;var g=e("[data-bg-index="+p+"]",n);u.push(l(g))}o[r?"append":"prepend"](u)}})}function l(r){var a=r[0].outerHTML;return a=a.replace("<div","<img"),a=a.replace("></div>"," />"),e(a).removeClass("_prevent-load")}function d(r){var a=document.body.classList.contains("new-design")?"White":"DarkGray";if(e(".new-4-cols-layout").length)var t=r.products.items;else var t=r;return t.map(function(r){if(e(".new-4-cols-layout").length)var t=r.primaryImage;else var t=r.imgBase;var i=Object.keys(t);return i.forEach(function(e){t[e]&&(t[e]=t[e].replace(a,"Transparent").replace(".jpg",".png"))}),r})}function s(r){function t(r){var a=g(),t=e(".product-tiles-grid-item",r);t=e(t.get(t.length-1));var i,o=e(".product-tiles-grid-item:not(.product-tiles-grid-promo-component)",r).length,n=e(".product-tiles-grid-promo-component").length;i=3===a?o%a:(o+2*n)%a,i&&(i=a-i);for(var l=0;i>l;l++)t.after('<article class="product-tiles-grid-item product-tiles-grid-item-medium product-tiles-grid-item-small hover-link" data-placeholder-cell="true"></article>')}e("[data-placeholder-cell]").remove(),a.is("large")&&(e(".new-4-cols-layout").data("has-large-backgrounds")||e(".capsule-products-grid").data("has-large-backgrounds"))&&t(r),a.is("medium")&&(e(".new-4-cols-layout").data("has-medium-backgrounds")||e(".capsule-products-grid").data("has-medium-backgrounds"))&&t(r),a.is("small")&&(e(".new-4-cols-layout").data("has-small-backgrounds")||e(".capsule-products-grid").data("has-small-backgrounds"))&&t(r)}function u(){e(".product-tiles-grid-item:not(.product-tiles-grid-promo-component)").filter(function(e){return a.is("medium")?e%3!=2:e%2===0}).addClass("border-right")}function c(e){var r=e?"#"+e:"";a.change(function(){s(r),p()}),s(r)}function p(){if(t.isChrome()||t.isSafari()||t.isFirefox||t.isIE){var r=m(),i=null,o=0,n=".product-tiles-grid-item:not(.product-tiles-grid-promo-component)";(e('[data-start-page="0"]').length||e(".page-zero-loaded").length)&&(a.is("medium")||(n=".product-tiles-grid-item")),a.is("large")||a.is("small")||e(n).each(function(a,t){var n=e(t).position().top;n!==i&&(e(".product-grid-row-background-wrapper--"+r+" img").eq(o).css("top",n),i=n,o++)})}}function g(){return a.is("small")?2:a.is("medium")?3:e(".new-4-cols-layout").length?4:5}function m(){return a.is("small")?"small":a.is("medium")?"medium":"large"}function h(){document.querySelectorAll("[data-requiremodule=quickPdp]").length>0?quickpdp=3:quickpdp=0;var r=i(),a=e(".product-tiles-grid-double-view-item").length>0,t=[{name:"small",rows:a?r:Math.ceil(r/2)},{name:"medium",rows:Math.ceil(r/3)},{name:"large",rows:Math.ceil(r/4)+quickpdp}];e.each(t,function(r,a){e(".product-grid-row-background-wrapper--"+a.name+":not(.product-grid-row-background-wrapper--"+a.name+"-hidden) img",v).each(function(r,t){r>=a.rows&&e(t).remove()})})}function f(){}var v=e(".product-tiles-grid"),w=o();return r.dispatchAndListen("productGridBackground",f),{loadMoreBackgrounds:n,mapToTransparentImages:d,adjustBackgroundRowsVisibility:h,adjustPosition:p,displayBlankCells:c,addBorderRight:u,getBreakpoints:m}});